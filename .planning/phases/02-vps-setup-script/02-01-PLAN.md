# Phase 2: VPS Setup Script

**Status:** Pending
**Priority:** Critical
**Estimated Effort:** 6-8 hours
**Depends On:** Phase 1 (Create Project Structure)

## Objective

Create a comprehensive one-command VPS setup script that automates the installation and configuration of all required components for running Sincronizado on Ubuntu 20.04+ or Debian 11+.

## Success Criteria

- [ ] Script runs successfully on fresh Ubuntu 20.04
- [ ] Script runs successfully on fresh Debian 11
- [ ] All dependencies installed without errors
- [ ] All OpenCode plugins installed and configured
- [ ] Firewall configured correctly (ports 2222, 3000)
- [ ] Validation checks pass
- [ ] Rollback capability works
- [ ] Documentation complete

---

## Tasks

### 2.1 Script Structure and OS Detection

Create `scripts/setup-vps.sh` with:
- Shebang and strict mode (`set -euo pipefail`)
- Color-coded output for readability
- Logging to file
- OS detection logic:
  - Check if Ubuntu 20.04+ or Debian 11+
  - Exit gracefully with error message if unsupported OS
  - Set OS-specific variables (package manager, paths)
- Root/sudo privilege check
- Display welcome message and summary of what will be installed

### 2.2 Install Base Dependencies

Install system packages:
- `git` (version control)
- `npm` (Node.js package manager)
- `direnv` (environment variable manager)
- `tmux` (terminal multiplexer)
- `curl` (HTTP client)
- `wget` (file downloader)
- `unzip` (archive extraction)
- `ufw` (firewall)

Use appropriate package manager:
- Ubuntu/Debian: `apt-get`

Update package list before installation.

### 2.3 Install Eternal Terminal (et)

Eternal Terminal provides resilient SSH connections that survive network changes.

Installation steps:
1. Check if already installed
2. Download from official GitHub releases (https://github.com/MisterTea/EternalTerminal)
3. Install dependencies (libssl-dev, libprotobuf-dev, etc.)
4. Build from source OR install pre-built binary
5. Configure et server
6. Start et service
7. Verify installation

### 2.4 Install Agent-OS

Agent-OS provides mobile web UI for remote access to sessions.

Installation:
```bash
npm install -g agent-os
cd /opt/agent-os
npm install
```

Configuration:
- Create systemd service for auto-start
- Configure port 3000
- Set up reverse proxy (if needed)
- Test web UI accessibility

### 2.5 Install OpenCode Plugins

Install all required plugins:

1. **opencode-direnv** (simonwjackson)
   - Purpose: Auto-load .envrc files
   - Install: Via opencode plugin system

2. **agentmap** (remorses)
   - Purpose: Tree view for headless VPS
   - Install: Via opencode plugin system

3. **opencode-sync** (tctinh)
   - Purpose: Sync settings via GitHub Gist
   - Install: Via opencode plugin system
   - Requires GitHub token setup

4. **ai-sessions-mcp** (yoavf)
   - Purpose: Search past sessions
   - Install: Via opencode plugin system

5. **ccmanager** (kbwo)
   - Purpose: Session management
   - Install: Via npm or opencode plugin system

### 2.6 Configure Firewall

Configure UFW (Uncomplicated Firewall):
- Enable UFW
- Allow SSH (port 22)
- Allow Eternal Terminal (port 2222)
- Allow Agent-OS Web UI (port 3000)
- Deny all other incoming traffic
- Display current status

Commands:
```bash
ufw default deny incoming
ufw default allow outgoing
ufw allow 22/tcp
ufw allow 2222/tcp
ufw allow 3000/tcp
ufw enable
```

### 2.7 Validation and Error Handling

Add comprehensive validation:
- Check each installation succeeded
- Verify services are running
- Test port accessibility
- Check disk space
- Verify user permissions
- Test plugin installations

Error handling:
- Set `set -euo pipefail` at top
- Trap errors and display helpful messages
- Log all output to file
- Provide retry logic for network operations
- Exit codes for different failure types

### 2.8 Create Rollback Script

Create `scripts/rollback-vps.sh`:
- Stop and remove services (et, agent-os)
- Uninstall packages
- Remove configuration files
- Reset firewall rules
- Clean up directories
- Display what was removed

Safety features:
- Confirmation prompt before destructive actions
- Backup important configs before removal
- Skip if critical system packages

### 2.9 Testing on Ubuntu 20.04

Test requirements:
- Fresh Ubuntu 20.04 VPS (DigitalOcean/AWS/GCP)
- Run setup-vps.sh
- Verify all components work:
  - SSH access
  - Eternal Terminal connection
  - Agent-OS web UI loads
  - All plugins installed
  - Firewall rules correct
- Document any issues

### 2.10 Testing on Debian 11

Same as 2.9 but on fresh Debian 11 VPS.
Verify all functionality works identically.

---

## Verification Steps

### Automated Checks
- Script exits with code 0
- All services report as running
- All ports accessible
- No errors in logs

### Manual Verification
- Can SSH into VPS
- Can connect via Eternal Terminal
- Agent-OS web UI loads at http://vps:3000
- Can list installed plugins
- Firewall status shows correct rules

### Integration Tests
- Test complete workflow: SSH → et → agent-os
- Verify file sync works (will be tested in Phase 4)
- Test session management with ccmanager

---

## Dependencies

### External Services
- GitHub (for plugin repositories)
- npm registry (for Node packages)
- Eternal Terminal GitHub releases

### Tools & Libraries
- Bash 4.0+
- apt-get (Ubuntu/Debian)
- systemd (for services)
- ufw (firewall)

---

## Risk Mitigation

- **Risk:** Network failure during installation
  - **Mitigation:** Retry logic with exponential backoff

- **Risk:** Partial installation leaves system in broken state
  - **Mitigation:** Validation after each step, rollback script

- **Risk:** Unsupported OS version
  - **Mitigation:** Clear OS detection with helpful error message

- **Risk:** Port conflicts
  - **Mitigation:** Check if ports in use before configuration

---

## Questions

1. **Eternal Terminal:** Build from source or use pre-built binary?
   - Pre-built binary faster but may not be available for all architectures
   - Building from source more reliable but takes longer
   - **Decision:** Try pre-built first, fallback to source build

2. **OpenCode plugins:** Install globally or per-user?
   - Global: All users can use
   - Per-user: Better isolation
   - **Decision:** Global for VPS setup (typically single-user)

3. **Agent-OS:** Run as systemd service or manual start?
   - Systemd: Auto-restart, better for production
   - Manual: Simpler, more control
   - **Decision:** Systemd service with auto-start

---

## Definition of Done

- [ ] All tasks completed
- [ ] Tests pass on Ubuntu 20.04
- [ ] Tests pass on Debian 11
- [ ] Rollback script tested
- [ ] Documentation updated
- [ ] Script committed to repository
- [ ] README updated with VPS setup instructions

---

## Notes

- Keep script idempotent (safe to run multiple times)
- Log everything to /var/log/sincronizado-setup.log
- Use colors for readability: green=success, red=error, yellow=warning
- Include progress indicators for long operations
- Test with minimal VPS specs (1GB RAM, 1 CPU) to ensure it works for everyone
